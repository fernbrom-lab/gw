<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢³æ’ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input, select, button { transition: all 0.15s ease; }
        input:focus, select:focus { outline: 2px solid #3b82f6; outline-offset: 2px; }
        input[type="file"]::file-selector-button {
            background: #e2e8f0; border: none; padding: 0.5rem 1rem; border-radius: 0.75rem;
            font-weight: 600; color: #1e293b; margin-right: 1rem; cursor: pointer;
        }
        input[type="file"]::file-selector-button:hover { background: #cbd5e1; }
        .upload-success { background-color: #f0fdf4; border: 1px solid #86efac; }
        .upload-error { background-color: #fef2f2; border: 1px solid #fecaca; }
    </style>
</head>
<body class="bg-slate-50 p-4 font-sans text-sm antialiased">
    <div class="max-w-xl mx-auto space-y-6">
        <!-- ç‹€æ…‹åˆ— -->
        <div class="bg-white p-4 rounded-2xl shadow-sm flex items-center justify-between text-xs text-gray-500 border">
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span>å¾Œç«¯: <span id="backend-status" class="font-mono">æª¢æŸ¥ä¸­...</span></span>
            </div>
            <div>
                <a href="/" class="text-blue-600 hover:text-blue-800" target="_blank">å‰å¾€å‰å°</a>
            </div>
        </div>

        <!-- æ¤ç‰©å…¥åº« -->
        <div class="bg-white p-6 rounded-3xl shadow-lg border border-green-200">
            <h2 class="text-xl font-bold text-green-700 mb-4 italic">ğŸŒ¿ æ¤ç‰©å…¥åº«æ•¸æ“š</h2>
            <form id="farmForm" class="grid grid-cols-2 gap-3">
                <input type="text" name="batch_number" placeholder="æ‰¹è™Ÿ *" required
                       class="col-span-2 border p-3 rounded-xl bg-white focus:ring-2 focus:ring-green-200">
                <input type="text" name="plant_name" placeholder="å“ç¨®" 
                       class="border p-3 rounded-xl bg-white focus:ring-2 focus:ring-green-200">
                <input type="number" name="quantity" placeholder="æ•¸é‡" 
                       class="border p-3 rounded-xl bg-white focus:ring-2 focus:ring-green-200">
                <div class="space-y-1">
                    <label class="text-[10px] ml-1 font-bold text-gray-400">ğŸ“… é€²è²¨æ—¥</label>
                    <input type="date" name="in_date" class="w-full border p-2 rounded-xl bg-white">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] ml-1 font-bold text-gray-400">ğŸ“† å‡ºè²¨æ—¥</label>
                    <input type="date" name="out_date" class="w-full border p-2 rounded-xl bg-white">
                </div>
                <input type="file" name="photo" accept="image/*" 
                       class="col-span-2 text-xs border p-2 rounded-xl file:mr-3 file:bg-green-100 file:text-green-800 file:border-0 file:rounded-lg">
                <button type="button" onclick="saveFarm()" 
                        class="col-span-2 bg-green-600 hover:bg-green-700 active:scale-[0.98] text-white py-3 rounded-xl font-bold shadow-md">
                    ä¸Šå‚³è¾²å ´æ•¸æ“š
                </button>
            </form>
            <!-- ä¸Šå‚³çµæœé¡¯ç¤º -->
            <div id="farm-result" class="mt-4 p-3 rounded-xl text-sm hidden"></div>
        </div>

        <!-- å·¥ç¨‹æ¡ˆå ´ -->
        <div class="bg-white p-6 rounded-3xl shadow-lg border border-blue-200">
            <h2 class="text-xl font-bold text-blue-700 mb-4 italic">ğŸ—ï¸ æ–½å·¥èˆ‡ç‰©æ–™ç™»éŒ„</h2>
            <div class="space-y-4">
                <input type="text" id="p_name" placeholder="æ¡ˆå ´åç¨±" 
                       class="w-full border p-3 rounded-xl bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-200">
                
                <div class="grid grid-cols-2 gap-3">
                    <select id="p_grid_type" class="border p-3 rounded-xl bg-white">
                        <option value="spot_weld">âš¡ é»éŠ²ç¶²</option>
                        <option value="galvanized">ğŸ”© éé‹…éµç¶²</option>
                        <option value="stainless">âœ¨ ä¸éŠ¹é‹¼ç¶²</option>
                    </select>
                    <input type="number" id="p_grid_weight" placeholder="çµæ§‹é‡ (kg)" step="0.1" class="border p-3 rounded-xl">
                    <input type="number" id="p_diesel" placeholder="æŸ´æ²¹ (L)" step="0.1" class="border p-3 rounded-xl">
                    <input type="number" id="p_gasoline" placeholder="æ±½æ²¹ (L)" step="0.1" class="border p-3 rounded-xl">
                    <input type="number" id="p_days" placeholder="æ–½å·¥å¤©æ•¸" step="0.5" class="border p-3 rounded-xl">
                    <input type="number" id="p_pots" placeholder="èŠ±æ§½æ•¸é‡" class="border p-3 rounded-xl">
                    <input type="number" id="p_layers" placeholder="æ»´çŒå±¤æ•¸" class="border p-3 rounded-xl">
                    <input type="number" id="p_drip_len" placeholder="å–®å±¤é•·åº¦(m)" step="0.1" class="border p-3 rounded-xl">
                    <input type="number" id="p_plants" placeholder="æ¤ç‰©ç¸½é‡" class="border p-3 rounded-xl">
                    <input type="number" id="p_water" placeholder="é ä¼°ç”¨æ°´(L)" step="0.1" class="border p-3 rounded-xl">
                </div>
                
                <input type="number" id="p_acc" placeholder="é…ä»¶é‡é‡(kg)" step="0.1" 
                       class="w-full border p-3 rounded-xl bg-gray-50 focus:bg-white">
                
                <button type="button" onclick="saveProject()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 active:scale-[0.98] text-white py-4 rounded-xl font-bold shadow-lg">
                    å»ºç«‹æ¡ˆå ´
                </button>
            </div>
            <!-- æ¡ˆå ´ä¸Šå‚³çµæœ -->
            <div id="project-result" class="mt-4 p-3 rounded-xl text-sm hidden"></div>
        </div>

        <!-- é¡¯ç¤ºæœ€è¿‘ä¸Šå‚³çš„è³‡æ–™ -->
        <div class="bg-white p-6 rounded-3xl shadow-lg">
            <h3 class="font-bold text-lg mb-4">ğŸ“‹ æœ€è¿‘ä¸Šå‚³ç´€éŒ„</h3>
            <div id="recent-data" class="text-sm text-gray-700">
                è¼‰å…¥ä¸­...
            </div>
        </div>
    </div>

    <script>
        // æª¢æŸ¥å¾Œç«¯ç‹€æ…‹
        async function checkBackend() {
            try {
                const res = await fetch('/api/test');
                const data = await res.json();
                document.getElementById('backend-status').innerText = 'âœ… é€£ç·šæ­£å¸¸';
            } catch (e) {
                document.getElementById('backend-status').innerText = 'âŒ ç„¡æ³•é€£ç·š';
            }
        }

        // è¼‰å…¥æœ€è¿‘è³‡æ–™
        async function loadRecent() {
            try {
                const [farmsRes, projectsRes] = await Promise.all([
                    fetch('/api/farms'),
                    fetch('/api/projects')
                ]);
                
                const farms = await farmsRes.json();
                const projects = await projectsRes.json();
                
                let html = '<div class="space-y-3">';
                
                html += '<p class="font-bold text-green-700">ğŸ“¦ æœ€è¿‘è¾²å ´è³‡æ–™</p>';
                if (farms.length === 0) {
                    html += '<p class="text-gray-400 text-xs">å°šç„¡è³‡æ–™</p>';
                } else {
                    farms.slice(0, 5).forEach(f => {
                        html += `<div class="border-l-4 border-green-300 pl-3 py-2 bg-green-50/30 rounded">
                            <div class="font-medium">${f.batch_number || 'ç„¡æ‰¹è™Ÿ'}</div>
                            <div class="text-xs text-gray-600">${f.plant_name || 'æœªå¡«'} | ${f.quantity || 0}æ ª</div>
                            <div class="text-xs text-gray-400">${f.photo_url ? 'ğŸ“¸ æœ‰ç…§ç‰‡' : 'ğŸ“¸ ç„¡ç…§ç‰‡'}</div>
                        </div>`;
                    });
                }
                
                html += '<p class="font-bold text-blue-700 mt-4">ğŸ—ï¸ æœ€è¿‘æ¡ˆå ´</p>';
                if (projects.length === 0) {
                    html += '<p class="text-gray-400 text-xs">å°šç„¡è³‡æ–™</p>';
                } else {
                    projects.slice(0, 5).forEach(p => {
                        html += `<div class="border-l-4 border-blue-300 pl-3 py-2 bg-blue-50/30 rounded">
                            <div class="font-medium">${p.project_name || 'æœªå‘½å'}</div>
                            <div class="text-xs text-gray-600">ID: ${p.id?.substring(0,8) || 'N/A'}...</div>
                        </div>`;
                    });
                }
                
                html += '</div>';
                document.getElementById('recent-data').innerHTML = html;
            } catch (e) {
                document.getElementById('recent-data').innerHTML = 'âŒ ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼š' + e.message;
            }
        }

        // å„²å­˜è¾²å ´
        async function saveFarm() {
            const form = document.getElementById('farmForm');
            const formData = new FormData(form);
            const resultDiv = document.getElementById('farm-result');

            // æª¢æŸ¥æ‰¹è™Ÿ
            if (!formData.get('batch_number')) {
                alert('è«‹å¡«å¯«æ‰¹è™Ÿ');
                return;
            }

            // é¡¯ç¤ºä¸Šå‚³ä¸­
            resultDiv.className = 'mt-4 p-3 rounded-xl text-sm bg-yellow-100 text-yellow-800';
            resultDiv.innerHTML = 'â³ ä¸Šå‚³ä¸­...';
            resultDiv.classList.remove('hidden');

            try {
                const res = await fetch('/api/add_farm', {
                    method: 'POST',
                    body: formData
                });

                const result = await res.json();
                
                if (res.ok) {
                    resultDiv.className = 'mt-4 p-3 rounded-xl text-sm bg-green-100 text-green-800';
                    resultDiv.innerHTML = `
                        âœ… ä¸Šå‚³æˆåŠŸ<br>
                        æ‰¹è™Ÿ: ${formData.get('batch_number')}<br>
                        ${result.photo_url ? 'ğŸ“¸ ç…§ç‰‡å·²ä¸Šå‚³' : 'ğŸ“¸ ç„¡ç…§ç‰‡'}
                    `;
                    form.reset();
                    loadRecent(); // é‡æ–°è¼‰å…¥æœ€è¿‘è³‡æ–™
                } else {
                    resultDiv.className = 'mt-4 p-3 rounded-xl text-sm bg-red-100 text-red-800';
                    resultDiv.innerHTML = 'âŒ éŒ¯èª¤ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤');
                }
            } catch (e) {
                resultDiv.className = 'mt-4 p-3 rounded-xl text-sm bg-red-100 text-red-800';
                resultDiv.innerHTML = 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message;
            }
        }

        // å„²å­˜æ¡ˆå ´
        async function saveProject() {
            const payload = {
                project_name: document.getElementById('p_name').value.trim() || 'æœªå‘½åæ¡ˆå ´',
                grid_type: document.getElementById('p_grid_type').value,
                grid_weight: parseFloat(document.getElementById('p_grid_weight').value) || 0,
                diesel_liters: parseFloat(document.getElementById('p_diesel').value) || 0,
                gasoline_liters: parseFloat(document.getElementById('p_gasoline').value) || 0,
                est_days: parseFloat(document.getElementById('p_days').value) || 0,
                pot_count: parseInt(document.getElementById('p_pots').value) || 0,
                plant_total_count: parseInt(document.getElementById('p_plants').value) || 0,
                drip_layers: parseInt(document.getElementById('p_layers').value) || 0,
                drip_len: parseFloat(document.getElementById('p_drip_len').value) || 0,
                water_est: parseFloat(document.getElementById('p_water').value) || 0,
                acc_weight: parseFloat(document.getElementById('p_acc').value) || 0
            };

            const resultDiv = document.getElementById('project-result');

            // é¡¯ç¤ºä¸Šå‚³ä¸­
            resultDiv.className = 'mt-4 p-3 rounded-xl text-sm bg-yellow-100 text-yellow-800';
            resultDiv.innerHTML = 'â³ å»ºç«‹ä¸­...';
            resultDiv.classList.remove('hidden');

            try {
                const res = await fetch('/api/add_project', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const result = await res.json();
                
                if (res.ok) {
                    resultDiv.className = 'mt-4 p-3 rounded-xl text-sm bg-green-100 text-green-800';
                    resultDiv.innerHTML = 'âœ… æ¡ˆå ´å»ºç«‹æˆåŠŸï¼š' + payload.project_name;
                    
                    // æ¸…ç©ºè¡¨å–®
                    document.getElementById('p_name').value = '';
                    document.getElementById('p_grid_weight').value = '';
                    document.getElementById('p_diesel').value = '';
                    document.getElementById('p_gasoline').value = '';
                    document.getElementById('p_days').value = '';
                    document.getElementById('p_pots').value = '';
                    document.getElementById('p_plants').value = '';
                    document.getElementById('p_layers').value = '';
                    document.getElementById('p_drip_len').value = '';
                    document.getElementById('p_water').value = '';
                    document.getElementById('p_acc').value = '';
                    
                    loadRecent(); // é‡æ–°è¼‰å…¥æœ€è¿‘è³‡æ–™
                } else {
                    resultDiv.className = 'mt-4 p-3 rounded-xl text-sm bg-red-100 text-red-800';
                    resultDiv.innerHTML = 'âŒ éŒ¯èª¤ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤');
                }
            } catch (e) {
                resultDiv.className = 'mt-4 p-3 rounded-xl text-sm bg-red-100 text-red-800';
                resultDiv.innerHTML = 'âŒ é€£ç·šå¤±æ•—ï¼š' + e.message;
            }
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            checkBackend();
            loadRecent();
        };
    </script>
</body>
</html>
