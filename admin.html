<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>è¾²å ´ç¢³ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            overflow-y: auto;
            padding: 1rem;
        }
        .modal.show { 
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .delete-btn { 
            opacity: 0; 
            transition: opacity 0.2s; 
        }
        .record-item:hover .delete-btn { 
            opacity: 1; 
        }
        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 250px;
            background-color: #1e293b;
            color: #fff;
            text-align: left;
            border-radius: 0.75rem;
            padding: 0.75rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.7rem;
            font-weight: normal;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
        }
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 p-3">
    <div class="max-w-4xl mx-auto">
        <!-- æ¨™é ­ -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-black text-green-800">ğŸŒ¿ è¾²å ´ç¢³ç®¡ç†å¾Œå°</h1>
            <div class="flex gap-2">
                <a href="/" target="_blank" class="text-sm bg-gray-200 px-3 py-1.5 rounded-full">å‰å°</a>
                <button onclick="loadBatches()" class="text-sm bg-blue-100 px-3 py-1.5 rounded-full">ğŸ”„ é‡æ–°æ•´ç†</button>
            </div>
        </div>
        
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-3 gap-2 mb-4">
            <div class="bg-white p-3 rounded-xl shadow">
                <div class="text-xs text-gray-500">ç¸½åº«å­˜</div>
                <div class="text-xl font-bold text-green-600" id="stat-total">0</div>
            </div>
            <div class="bg-white p-3 rounded-xl shadow">
                <div class="text-xs text-gray-500">ç¢³å¸æ”¶é‡</div>
                <div class="text-xl font-bold text-blue-600" id="stat-carbon">0 kg</div>
            </div>
            <div class="bg-white p-3 rounded-xl shadow">
                <div class="text-xs text-gray-500">é€²è¡Œä¸­æ‰¹æ¬¡</div>
                <div class="text-xl font-bold text-purple-600" id="stat-batches">0</div>
            </div>
        </div>
        
        <!-- æ–°å¢æ‰¹æ¬¡æŒ‰éˆ• -->
        <button onclick="showAddFarmModal()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold mb-4 hover:bg-green-700 active:scale-[0.99]">
            â• æ–°å¢æ¤ç‰©æ‰¹æ¬¡
        </button>

        <!-- æ‰¹æ¬¡åˆ—è¡¨ -->
        <div id="batches-list" class="space-y-3">
            è¼‰å…¥ä¸­...
        </div>
    </div>

    <!-- æ–°å¢æ‰¹æ¬¡ Modal -->
    <div id="addFarmModal" class="modal">
        <div class="modal-content bg-white p-6 rounded-2xl max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">æ–°å¢æ¤ç‰©æ‰¹æ¬¡</h2>
            <form id="addFarmForm" class="space-y-3">
                <!-- åŸºæœ¬è³‡è¨Š -->
                <input type="text" name="batch_number" placeholder="æ‰¹è™Ÿ *" required class="w-full border p-3 rounded-xl">
                <input type="text" name="plant_name" placeholder="å“ç¨®åç¨±" class="w-full border p-3 rounded-xl">
                
                <!-- æ¤ç‰©é¡å‹ -->
                <select name="plant_type" class="w-full border p-3 rounded-xl">
                    <option value="é¹¿è§’è•¨">ğŸ¦Œ é¹¿è§’è•¨ (0.06 kg/æœˆ)</option>
                    <option value="ç©æ°´é³³æ¢¨">ğŸ ç©æ°´é³³æ¢¨ (0.04 kg/æœˆ)</option>
                    <option value="å…¶ä»–" selected>ğŸŒ¿ å…¶ä»–æ¤ç‰© (0.05 kg/æœˆ)</option>
                </select>
                
                <!-- æ¤ç‰©å¤§å° -->
                <select name="plant_size" class="w-full border p-3 rounded-xl">
                    <option value="small">ğŸŒ± å° (3å‹ä»¥ä¸‹ / è‘‰å±•<20cm) x0.5</option>
                    <option value="medium" selected>ğŸŒ¿ ä¸­ (4-6å‹ / è‘‰å±•20-40cm) x1.0</option>
                    <option value="large">ğŸŒ³ å¤§ (7å‹ä»¥ä¸Š / è‘‰å±•>40cm) x1.5</option>
                </select>
                
                <!-- æ•¸é‡èˆ‡æ—¥æœŸ -->
                <input type="number" name="quantity" placeholder="åˆå§‹æ•¸é‡" required class="w-full border p-3 rounded-xl">
                <input type="date" name="in_date" class="w-full border p-3 rounded-xl">
                
                <!-- ä¾›æ‡‰å•†èˆ‡å‚™è¨» -->
                <input type="text" name="supplier" placeholder="ä¾›æ‡‰å•†" class="w-full border p-3 rounded-xl">
                <textarea name="notes" placeholder="å‚™è¨»" class="w-full border p-3 rounded-xl" rows="2"></textarea>
                
                <!-- ç…§ç‰‡ -->
                <input type="file" name="photo" accept="image/*" class="w-full border p-2 rounded-xl">
                
                <!-- è¨ˆç®—èªªæ˜ -->
                <div class="bg-blue-50 p-3 rounded-xl text-xs text-blue-800">
                    <p class="font-bold mb-1">ğŸŒ± ç¢³å¸æ”¶è¨ˆç®—èªªæ˜</p>
                    <p>å¸æ”¶é‡ = æ•¸é‡ Ã— åŸºç¤ä¿‚æ•¸ Ã— å¤§å°å€ç‡ Ã— åœ¨åº«æœˆä»½</p>
                    <p class="mt-1">ç¯„ä¾‹: 100æ ªä¸­é¹¿è§’è•¨åœ¨åº«3å€‹æœˆ = 100 Ã— 0.06 Ã— 1.0 Ã— 3 = 18 kg</p>
                </div>
                
                <!-- æŒ‰éˆ• -->
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="saveFarm()" class="flex-1 bg-green-600 text-white py-3 rounded-xl hover:bg-green-700">å„²å­˜</button>
                    <button type="button" onclick="hideModal('addFarmModal')" class="flex-1 bg-gray-200 py-3 rounded-xl hover:bg-gray-300">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç”Ÿé•·ç´€éŒ„ Modal -->
    <div id="growthModal" class="modal">
        <div class="modal-content bg-white p-6 rounded-2xl max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">ğŸ“¸ æ–°å¢ç”Ÿé•·ç´€éŒ„</h2>
            <form id="growthForm" class="space-y-3">
                <input type="hidden" id="growth_farm_id" name="farm_id">
                <input type="date" name="record_date" class="w-full border p-3 rounded-xl" required>
                <textarea name="notes" placeholder="è§€å¯Ÿç´€éŒ„ (ä¾‹å¦‚: é•·å‡ºæ–°è‘‰ã€æ¾†æ°´ã€æ–½è‚¥ç­‰)" class="w-full border p-3 rounded-xl" rows="3"></textarea>
                <input type="file" name="photo" accept="image/*" class="w-full border p-2 rounded-xl">
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="saveGrowthRecord()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700">å„²å­˜</button>
                    <button type="button" onclick="hideModal('growthModal')" class="flex-1 bg-gray-200 py-3 rounded-xl hover:bg-gray-300">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å‡ºè²¨ Modal -->
    <div id="shipmentModal" class="modal">
        <div class="modal-content bg-white p-6 rounded-2xl max-w-md w-full">
            <h2 class="text-xl font-bold mb-4">ğŸ“¦ æ–°å¢å‡ºè²¨</h2>
            <form id="shipmentForm" class="space-y-3">
                <input type="hidden" id="shipment_farm_id" name="farm_id">
                <input type="date" name="shipment_date" class="w-full border p-3 rounded-xl" required>
                <input type="number" name="quantity" placeholder="å‡ºè²¨æ•¸é‡" required class="w-full border p-3 rounded-xl">
                <input type="text" name="customer" placeholder="å®¢æˆ¶åç¨±" class="w-full border p-3 rounded-xl">
                <textarea name="notes" placeholder="å‚™è¨»" class="w-full border p-3 rounded-xl" rows="2"></textarea>
                <div class="flex gap-2 pt-2">
                    <button type="button" onclick="saveShipment()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl hover:bg-purple-700">å„²å­˜</button>
                    <button type="button" onclick="hideModal('shipmentModal')" class="flex-1 bg-gray-200 py-3 rounded-xl hover:bg-gray-300">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ========== Modal æ§åˆ¶ ==========
        function showModal(id) { 
            document.getElementById(id).classList.add('show'); 
        }
        
        function hideModal(id) { 
            document.getElementById(id).classList.remove('show'); 
        }
        
        function showAddFarmModal() {
            document.getElementById('addFarmForm').reset();
            showModal('addFarmModal');
        }
        
        function showGrowthModal(farmId) {
            document.getElementById('growth_farm_id').value = farmId;
            document.getElementById('growthForm').reset();
            showModal('growthModal');
        }
        
        function showShipmentModal(farmId) {
            document.getElementById('shipment_farm_id').value = farmId;
            document.getElementById('shipmentForm').reset();
            showModal('shipmentModal');
        }

        // ========== è¼‰å…¥æ‰€æœ‰æ‰¹æ¬¡ ==========
        async function loadBatches() {
            try {
                const res = await fetch('/api/farms');
                const data = await res.json();
                
                // æ›´æ–°çµ±è¨ˆ
                document.getElementById('stat-total').textContent = data.summary.total_plants;
                document.getElementById('stat-carbon').textContent = data.summary.total_carbon_kg + ' kg';
                document.getElementById('stat-batches').textContent = data.summary.active_batches;
                
                const container = document.getElementById('batches-list');
                
                if (data.farms.length === 0) {
                    container.innerHTML = '<p class="text-center py-10 text-gray-400 bg-white rounded-2xl">å°šç„¡è³‡æ–™ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢</p>';
                    return;
                }
                
                container.innerHTML = data.farms.map(farm => {
                    // å¤§å°é¡¯ç¤ºæ–‡å­—
                    const sizeText = {
                        'small': 'ğŸŒ± å°',
                        'medium': 'ğŸŒ¿ ä¸­',
                        'large': 'ğŸŒ³ å¤§'
                    }[farm.plant_size] || 'ğŸŒ¿ ä¸­';
                    
                    // ç¢³å¸æ”¶é¡¯ç¤º
                    const carbonText = farm.carbon_absorption ? 
                        `ğŸŒ± å¸æ”¶ ${farm.carbon_absorption} kg CO2` : 
                        'ğŸ“Š ç¢³å¸æ”¶è¨ˆç®—ä¸­';
                    
                    return `
                        <div class="bg-white rounded-2xl p-4 shadow">
                            <!-- æ‰¹æ¬¡æ¨™é ­ -->
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <h3 class="text-lg font-bold">${farm.batch_number}</h3>
                                        <span class="px-2 py-0.5 bg-green-100 text-green-800 text-xs rounded-full">${farm.plant_name || 'æœªå‘½å'}</span>
                                        <span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs rounded-full">${sizeText}</span>
                                    </div>
                                    
                                    <!-- æ•¸é‡è³‡è¨Š -->
                                    <div class="grid grid-cols-4 gap-2 mt-2 text-sm">
                                        <div>
                                            <span class="text-gray-400 text-xs">åˆå§‹</span>
                                            <span class="font-bold ml-1">${farm.initial_quantity}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400 text-xs">å·²å‡ºè²¨</span>
                                            <span class="font-bold ml-1 text-purple-600">${farm.total_shipped || 0}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400 text-xs">åº«å­˜</span>
                                            <span class="font-bold ml-1 text-green-600">${farm.quantity}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-400 text-xs">é€²è²¨æ—¥</span>
                                            <span class="ml-1 text-xs">${farm.in_date || 'ç„¡'}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- ç¢³å¸æ”¶ -->
                                    <div class="mt-1 text-xs text-blue-600 flex items-center gap-1">
                                        <span>${carbonText}</span>
                                        <span class="info-tooltip">
                                            <span class="text-gray-400">â“˜</span>
                                            <span class="tooltip-text">
                                                <strong>è¨ˆç®—æ˜ç´°</strong><br>
                                                é¡å‹: ${farm.plant_type || 'å…¶ä»–'}<br>
                                                å¤§å°: ${sizeText}<br>
                                                æ•¸é‡: ${farm.quantity}æ ª<br>
                                                åœ¨åº«å¤©æ•¸: è‡ªå‹•è¨ˆç®—
                                            </span>
                                        </span>
                                    </div>
                                    
                                    <!-- ä¾›æ‡‰å•†/å‚™è¨» -->
                                    ${farm.supplier ? `<div class="text-xs text-gray-400 mt-1">ğŸ­ ${farm.supplier}</div>` : ''}
                                    ${farm.notes ? `<div class="text-xs text-gray-500 mt-1">ğŸ“ ${farm.notes}</div>` : ''}
                                    ${farm.photo_url ? `<a href="${farm.photo_url}" target="_blank" class="text-xs text-blue-500 mt-1 inline-block">ğŸ“¸ æŸ¥çœ‹åˆå§‹ç…§ç‰‡</a>` : ''}
                                </div>
                                <button onclick="deleteFarm('${farm.id}')" class="text-red-500 hover:text-red-700 text-sm ml-2">ğŸ—‘ï¸</button>
                            </div>
                            
                            <!-- æ“ä½œæŒ‰éˆ• -->
                            <div class="flex gap-2 mb-3 border-t pt-3">
                                <button onclick="showGrowthModal('${farm.id}')" 
                                        class="flex-1 px-3 py-2 bg-blue-500 text-white rounded-xl text-sm hover:bg-blue-600">
                                    ğŸ“¸ ç”Ÿé•·
                                </button>
                                <button onclick="showShipmentModal('${farm.id}')" 
                                        class="flex-1 px-3 py-2 bg-purple-500 text-white rounded-xl text-sm hover:bg-purple-600">
                                    ğŸ“¦ å‡ºè²¨
                                </button>
                            </div>
                            
                            <!-- ç”Ÿé•·ç´€éŒ„ -->
                            ${farm.growth_records && farm.growth_records.length > 0 ? `
                                <div class="mb-2">
                                    <p class="text-xs font-bold text-gray-500 mb-1">ğŸ“¸ ç”Ÿé•·ç´€éŒ„ ${farm.growth_records.length}ç­†</p>
                                    <div class="space-y-1">
                                        ${farm.growth_records.map(g => `
                                            <div class="record-item flex items-start justify-between text-xs border-l-2 border-blue-300 pl-2 py-0.5 group">
                                                <div class="flex-1">
                                                    <span class="font-medium">${g.record_date}</span>
                                                    ${g.notes ? `<span class="text-gray-500 ml-1">${g.notes.substring(0,20)}${g.notes.length > 20 ? '...' : ''}</span>` : ''}
                                                    ${g.photo_url ? ` <a href="${g.photo_url}" target="_blank" class="text-blue-500">ğŸ“¸</a>` : ''}
                                                </div>
                                                <button onclick="deleteGrowthRecord('${g.id}')" 
                                                        class="delete-btn ml-2 text-red-400 hover:text-red-600 text-xs">
                                                    åˆªé™¤
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- å‡ºè²¨ç´€éŒ„ -->
                            ${farm.shipments && farm.shipments.length > 0 ? `
                                <div>
                                    <p class="text-xs font-bold text-gray-500 mb-1">ğŸ“¦ å‡ºè²¨ç´€éŒ„ ${farm.shipments.length}ç­†</p>
                                    <div class="space-y-1">
                                        ${farm.shipments.map(s => `
                                            <div class="record-item flex items-start justify-between text-xs border-l-2 border-purple-300 pl-2 py-0.5 group">
                                                <div class="flex-1">
                                                    <span class="font-medium">${s.shipment_date}</span>
                                                    <span class="text-purple-600 font-bold ml-1">${s.quantity}æ ª</span>
                                                    ${s.customer ? `<span class="text-gray-500 ml-1">${s.customer}</span>` : ''}
                                                </div>
                                                <button onclick="deleteShipment('${s.id}')" 
                                                        class="delete-btn ml-2 text-red-400 hover:text-red-600 text-xs">
                                                    åˆªé™¤
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (e) {
                console.error(e);
                document.getElementById('batches-list').innerHTML = '<p class="text-center py-10 text-red-500 bg-white rounded-2xl">è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</p>';
            }
        }

        // ========== æ–°å¢æ‰¹æ¬¡ ==========
        async function saveFarm() {
            const form = document.getElementById('addFarmForm');
            const formData = new FormData(form);
            
            if (!formData.get('batch_number')) {
                alert('è«‹å¡«å¯«æ‰¹è™Ÿ');
                return;
            }
            
            try {
                const res = await fetch('/api/add_farm', {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    alert('âœ… æ–°å¢æˆåŠŸ');
                    hideModal('addFarmModal');
                    loadBatches();
                } else {
                    const err = await res.json();
                    alert('âŒ éŒ¯èª¤ï¼š' + (err.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                alert('âŒ é€£ç·šå¤±æ•—');
            }
        }

        // ========== æ–°å¢ç”Ÿé•·ç´€éŒ„ ==========
        async function saveGrowthRecord() {
            const form = document.getElementById('growthForm');
            const formData = new FormData(form);
            
            try {
                const res = await fetch('/api/add_growth_record', {
                    method: 'POST',
                    body: formData
                });
                
                if (res.ok) {
                    alert('âœ… ç”Ÿé•·ç´€éŒ„å·²å„²å­˜');
                    hideModal('growthModal');
                    loadBatches();
                } else {
                    const err = await res.json();
                    alert('âŒ éŒ¯èª¤ï¼š' + (err.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                alert('âŒ é€£ç·šå¤±æ•—');
            }
        }

        // ========== æ–°å¢å‡ºè²¨ ==========
        async function saveShipment() {
            const form = document.getElementById('shipmentForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            if (!data.quantity || parseInt(data.quantity) <= 0) {
                alert('è«‹å¡«å¯«æ­£ç¢ºçš„å‡ºè²¨æ•¸é‡');
                return;
            }
            
            try {
                const res = await fetch('/api/add_shipment', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (res.ok) {
                    alert('âœ… å‡ºè²¨ç´€éŒ„å·²å„²å­˜');
                    hideModal('shipmentModal');
                    loadBatches();
                } else {
                    const err = await res.json();
                    alert('âŒ éŒ¯èª¤ï¼š' + (err.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (e) {
                alert('âŒ é€£ç·šå¤±æ•—');
            }
        }

        // ========== åˆªé™¤ç”Ÿé•·ç´€éŒ„ ==========
        async function deleteGrowthRecord(recordId) {
            if (!confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç”Ÿé•·ç´€éŒ„å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/delete_growth_record/${recordId}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    alert('âœ… åˆªé™¤æˆåŠŸ');
                    loadBatches();
                } else {
                    alert('âŒ åˆªé™¤å¤±æ•—');
                }
            } catch (e) {
                alert('âŒ é€£ç·šå¤±æ•—');
            }
        }

        // ========== åˆªé™¤å‡ºè²¨ç´€éŒ„ ==========
        async function deleteShipment(shipmentId) {
            if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å‡ºè²¨ç´€éŒ„å—ï¼Ÿåº«å­˜å°‡æœƒè‡ªå‹•æ¢å¾©ã€‚')) return;
            
            try {
                const res = await fetch(`/api/delete_shipment/${shipmentId}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    alert('âœ… åˆªé™¤æˆåŠŸ');
                    loadBatches();
                } else {
                    alert('âŒ åˆªé™¤å¤±æ•—');
                }
            } catch (e) {
                alert('âŒ é€£ç·šå¤±æ•—');
            }
        }

        // ========== åˆªé™¤æ•´å€‹æ‰¹æ¬¡ ==========
        async function deleteFarm(farmId) {
            if (!confirm('âš ï¸ ç¢ºå®šåˆªé™¤æ•´å€‹æ‰¹æ¬¡ï¼Ÿæ‰€æœ‰ç”Ÿé•·ç´€éŒ„å’Œå‡ºè²¨ç´€éŒ„ä¹Ÿæœƒä¸€ä½µåˆªé™¤ï¼')) return;
            
            try {
                const res = await fetch(`/api/delete_farm/${farmId}`, {
                    method: 'DELETE'
                });
                
                if (res.ok) {
                    alert('âœ… åˆªé™¤æˆåŠŸ');
                    loadBatches();
                } else {
                    alert('âŒ åˆªé™¤å¤±æ•—');
                }
            } catch (e) {
                alert('âŒ é€£ç·šå¤±æ•—');
            }
        }

        // ========== åˆå§‹åŒ– ==========
        window.onload = loadBatches;
    </script>
</body>
</html>
