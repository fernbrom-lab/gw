<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è•¨ç© | æ•¸æ“šç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 p-6">
    <div class="max-w-xl mx-auto space-y-8">
        <h1 class="text-2xl font-black text-slate-800">è•¨ç© ç®¡ç†å¾Œå°</h1>

        <div class="bg-white p-6 rounded-2xl shadow-xl">
            <h2 class="text-xl font-bold text-green-700 mb-4 flex items-center">
                <span class="mr-2">ğŸŒ¿</span> è¾²å ´æ•¸æ“šç™»éŒ„
            </h2>
            <form id="farmForm" class="space-y-4">
                <input type="text" id="batch_number" placeholder="æ‰¹è™Ÿ (å¦‚: B2026-001)" class="w-full border p-3 rounded-xl bg-gray-50 outline-none focus:border-green-500">
                <input type="text" id="plant_name" placeholder="æ¤ç‰©å“ç¨®" class="w-full border p-3 rounded-xl bg-gray-50 outline-none focus:border-green-500">
                <div class="grid grid-cols-2 gap-3">
                    <label class="text-xs text-gray-400">é€²è²¨æ—¥<input type="date" id="in_date" class="w-full border p-2 rounded-lg mt-1"></label>
                    <label class="text-xs text-gray-400">å‡ºè²¨æ—¥<input type="date" id="out_date" class="w-full border p-2 rounded-lg mt-1"></label>
                </div>
                
                <div class="border-2 border-dashed border-gray-200 p-4 rounded-xl text-center">
                    <input type="file" id="photo_file" accept="image/*" class="hidden">
                    <button type="button" onclick="document.getElementById('photo_file').click()" class="text-sm bg-gray-200 px-4 py-2 rounded-lg">ğŸ“¸ é¸æ“‡æˆ–æ‹æ”ç…§ç‰‡</button>
                    <p id="upload-status" class="text-[10px] mt-2 text-gray-400 font-mono italic">å°šæœªä¸Šå‚³æª”æ¡ˆ</p>
                </div>

                <button type="button" id="btn-farm" onclick="submitFarm()" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">å„²å­˜ä¸¦ä¸Šå‚³</button>
            </form>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-xl">
            <h2 class="text-xl font-bold text-blue-700 mb-4 flex items-center">
                <span class="mr-2">ğŸ—ï¸</span> æ–°å¢æ¡ˆå ´è³‡æ–™
            </h2>
            <form id="projectForm" class="space-y-4">
                <input type="text" id="p_name" placeholder="å»ºæ¡ˆåç¨±" class="w-full border p-3 rounded-xl bg-gray-50">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="p_area" placeholder="å¹³æ–¹ç±³" class="border p-3 rounded-xl bg-gray-50">
                    <input type="number" id="p_plants" placeholder="æ¤æ ½æ•¸" class="border p-3 rounded-xl bg-gray-50">
                </div>
                <label class="flex items-center space-x-2 text-sm font-bold text-gray-600">
                    <input type="checkbox" id="p_recycled" class="w-4 h-4"> <span>ä½¿ç”¨å¾ªç’°è³‡æ (ç¢³æ’å„ªå¾…)</span>
                </label>
                <button type="button" onclick="submitProject()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition">å»ºç«‹æ¡ˆå ´</button>
            </form>
        </div>
    </div>

    <script>
        // å¾å¾Œç«¯ç²å– Supabase é…ç½® (æˆ–è€…ä½ å¯ä»¥ç›´æ¥åœ¨é€™é‚Šå¯«æ­» URL/KEY)
        const supabaseUrl = 'https://fvvbmedluaipqiqjiujj.supabase.co';
        const supabaseKey = 'sb_publishable_Y84MXL8nTojn_QJ_ba1e3w_GV7S7QRt';
        const supabase = supabasejs.createClient(supabaseUrl, supabaseKey);

        async function submitFarm() {
            const btn = document.getElementById('btn-farm');
            const fileInput = document.getElementById('photo_file');
            const file = fileInput.files[0];
            let photoUrl = "";

            btn.innerText = "ä¸Šå‚³ä¸­...";
            btn.disabled = true;

            // 1. ä¸Šå‚³åœ–ç‰‡åˆ° Supabase Storage
            if (file) {
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}.${fileExt}`;
                const { data, error } = await supabase.storage.from('evidences').upload(fileName, file);
                
                if (error) { alert('åœ–ç‰‡ä¸Šå‚³å¤±æ•—'); return; }
                const { data: publicUrlData } = supabase.storage.from('evidences').getPublicUrl(fileName);
                photoUrl = publicUrlData.publicUrl;
            }

            // 2. å­˜å…¥è³‡æ–™åº«
            const payload = {
                batch_number: document.getElementById('batch_number').value,
                plant_name: document.getElementById('plant_name').value,
                in_stock_date: document.getElementById('in_date').value,
                out_stock_date: document.getElementById('out_date').value,
                photo_url: photoUrl
            };

            const res = await fetch('/api/add_farm', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(payload) 
            });

            if (res.ok) { alert('è¾²å ´æ•¸æ“šç™»éŒ„æˆåŠŸï¼'); location.reload(); }
            btn.innerText = "å„²å­˜ä¸¦ä¸Šå‚³";
            btn.disabled = false;
        }

        async function submitProject() {
            const data = {
                project_name: document.getElementById('p_name').value,
                area_sqm: parseFloat(document.getElementById('p_area').value),
                plant_total_count: parseInt(document.getElementById('p_plants').value),
                is_recycled: document.getElementById('p_recycled').checked
            };
            await fetch('/api/add_project', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
            alert('æ¡ˆå ´å»ºç«‹å®Œæˆ');
            location.reload();
        }

        document.getElementById('photo_file').onchange = function() {
            document.getElementById('upload-status').innerText = "å·²é¸å–æª”æ¡ˆ: " + this.files[0].name;
        };
    </script>
</body>
</html>
