<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢³æ’ç®¡ç†å¾Œå° Â· è¾²å ´/å·¥ç¨‹è¼¸å…¥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input, select, button { transition: all 0.15s ease; }
        input:focus, select:focus { outline: 2px solid #3b82f6; outline-offset: 2px; }
        input[type="file"]::file-selector-button {
            background: #e2e8f0; border: none; padding: 0.5rem 1rem; border-radius: 0.75rem;
            font-weight: 600; color: #1e293b; margin-right: 1rem; cursor: pointer;
        }
        input[type="file"]::file-selector-button:hover { background: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-50 p-4 font-sans text-sm antialiased">
    <div class="max-w-xl mx-auto space-y-6">
        <!-- å¾Œå°ç‹€æ…‹æç¤º -->
        <div class="bg-white/70 backdrop-blur-sm p-3 rounded-2xl shadow-sm flex items-center justify-between text-xs text-gray-500 border">
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span>å¾Œç«¯é€£ç·š: <span class="font-mono">Supabase + Flask</span></span>
            </div>
        </div>

        <!-- æ¤ç‰©å…¥åº«å€å¡Š (ä¿®æ­£ name å±¬æ€§å°æ‡‰å¾Œç«¯) -->
        <div class="bg-white p-6 rounded-3xl shadow-lg border border-green-200">
            <h2 class="text-xl font-bold text-green-700 mb-4 italic flex items-center gap-2">
                <span>ğŸŒ¿</span> æ¤ç‰©å…¥åº«æ•¸æ“š
            </h2>
            <form id="farmForm" class="grid grid-cols-2 gap-3">
                <!-- æ‰¹è™Ÿ - å°æ‡‰å¾Œç«¯çš„ batch_number -->
                <input type="text" name="batch_number" placeholder="æ‰¹è™Ÿ * (ä¾‹å¦‚ B2025-0321)" required
                       class="col-span-2 border p-3 rounded-xl bg-white focus:bg-green-50/50">

                <!-- å“ç¨® - å°æ‡‰å¾Œç«¯çš„ plant_name -->
                <input type="text" name="plant_name" placeholder="å“ç¨® (å¦‚ å¥¶æ²¹ç™½èœ)" 
                       class="border p-3 rounded-xl bg-white focus:bg-green-50/50">
                
                <!-- æ•¸é‡ - å°æ‡‰å¾Œç«¯çš„ quantity -->
                <input type="number" name="quantity" placeholder="æ•¸é‡ (æ ª)" 
                       class="border p-3 rounded-xl bg-white focus:bg-green-50/50">

                <!-- é€²è²¨æ—¥ - å°æ‡‰å¾Œç«¯çš„ in_date (å¾Œç«¯æœƒè½‰æˆ in_stock_date) -->
                <div class="space-y-1">
                    <label class="text-[10px] ml-1 font-bold text-gray-400">ğŸ“… é€²è²¨æ—¥</label>
                    <input type="date" name="in_date" 
                           class="w-full border p-2 rounded-xl bg-white focus:bg-green-50/50">
                </div>
                
                <!-- å‡ºè²¨æ—¥ - å°æ‡‰å¾Œç«¯çš„ out_date (å¾Œç«¯æœƒè½‰æˆ out_stock_date) -->
                <div class="space-y-1">
                    <label class="text-[10px] ml-1 font-bold text-gray-400">ğŸ“† å‡ºè²¨æ—¥</label>
                    <input type="date" name="out_date" 
                           class="w-full border p-2 rounded-xl bg-white focus:bg-green-50/50">
                </div>

                <!-- ç…§ç‰‡ä¸Šå‚³ - å°æ‡‰å¾Œç«¯çš„ photo -->
                <input type="file" name="photo" accept="image/*" 
                       class="col-span-2 text-xs border p-2 rounded-xl file:mr-3 file:bg-green-100 file:text-green-800 file:border-0 file:rounded-lg">

                <!-- ä¸Šå‚³æŒ‰éˆ• -->
                <button type="button" onclick="saveFarm()" 
                        class="col-span-2 bg-green-600 hover:bg-green-700 active:scale-[0.98] text-white py-3 rounded-xl font-bold shadow-md">
                    ä¸Šå‚³è¾²å ´æ•¸æ“š
                </button>
            </form>
        </div>

        <!-- æ–½å·¥èˆ‡ç‰©æ–™ç™»éŒ„å€å¡Š (ä¿®æ­£ id å°æ‡‰å¾Œç«¯) -->
        <div class="bg-white p-6 rounded-3xl shadow-lg border border-blue-200">
            <h2 class="text-xl font-bold text-blue-700 mb-4 italic flex items-center gap-2">
                <span>ğŸ—ï¸</span> æ–½å·¥èˆ‡ç‰©æ–™ç™»éŒ„
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">ISO Cat.4</span>
            </h2>
            
            <div class="space-y-4">
                <!-- æ¡ˆå ´åç¨± - å°æ‡‰ project_name -->
                <input type="text" id="p_name" placeholder="æ¡ˆå ´åç¨± (ä¾‹å¦‚ é™½å…‰æº«å®¤Då€)" 
                       class="w-full border p-3 rounded-xl bg-gray-50 focus:bg-white">

                <!-- ç¬¬ä¸€çµ„ï¼šç¶²ç¨® / çµæ§‹é‡ / æŸ´æ²¹ / æ±½æ²¹ -->
                <div class="grid grid-cols-2 gap-3">
                    <select id="p_grid_type" class="border p-3 rounded-xl bg-white">
                        <option value="spot_weld">âš¡ é»éŠ²ç¶²</option>
                        <option value="galvanized">ğŸ”© éé‹…éµç¶²</option>
                        <option value="stainless">âœ¨ ä¸éŠ¹é‹¼ç¶²</option>
                    </select>
                    <input type="number" id="p_grid_weight" placeholder="çµæ§‹é‡ (kg)" step="0.1" min="0"
                           class="border p-3 rounded-xl bg-white">
                    <input type="number" id="p_diesel" placeholder="æŸ´æ²¹æ¶ˆè€— (L)" step="0.1" min="0"
                           class="border p-3 rounded-xl bg-white">
                    <input type="number" id="p_gasoline" placeholder="æ±½æ²¹æ¶ˆè€— (L)" step="0.1" min="0"
                           class="border p-3 rounded-xl bg-white">
                </div>

                <!-- ç¬¬äºŒçµ„ï¼šæ–½å·¥å¤©æ•¸ / èŠ±æ§½æ•¸é‡ / æ»´çŒå±¤æ•¸ / å–®å±¤é•·åº¦ -->
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="p_days" placeholder="æ–½å·¥å¤©æ•¸" step="0.5" min="0"
                           class="border p-3 rounded-xl bg-white">
                    <input type="number" id="p_pots" placeholder="èŠ±æ§½æ•¸é‡" min="0"
                           class="border p-3 rounded-xl bg-white">
                    <input type="number" id="p_layers" placeholder="æ»´çŒå±¤æ•¸" min="0"
                           class="border p-3 rounded-xl bg-white">
                    <input type="number" id="p_drip_len" placeholder="å–®å±¤é•·åº¦ (m)" step="0.1" min="0"
                           class="border p-3 rounded-xl bg-white">
                </div>

                <!-- ç¬¬ä¸‰çµ„ï¼šæ¤ç‰©ç¸½é‡ / é ä¼°ç”¨æ°´ -->
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="p_plants" placeholder="æ¤ç‰©ç¸½é‡ (æ ª)" min="0"
                           class="border p-3 rounded-xl bg-white">
                    <input type="number" id="p_water" placeholder="é ä¼°ç”¨æ°´ (L)" step="0.1" min="0"
                           class="border p-3 rounded-xl bg-white">
                </div>

                <!-- å…¶é¤˜é…ä»¶é‡é‡ -->
                <input type="number" id="p_acc" placeholder="å…¶é¤˜é…ä»¶é‡é‡ (kg)" step="0.1" min="0"
                       class="w-full border p-3 rounded-xl bg-gray-50 focus:bg-white">

                <!-- å»ºç«‹æ¡ˆå ´æŒ‰éˆ• -->
                <button type="button" onclick="saveProject()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 active:scale-[0.98] text-white py-4 rounded-xl font-black shadow-lg">
                    å»ºç«‹æ¡ˆå ´
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== è¾²å ´æ•¸æ“šä¸Šå‚³ ====================
        async function saveFarm() {
            const form = document.getElementById('farmForm');
            const formData = new FormData(form);

            // æª¢æŸ¥æ‰¹è™Ÿ
            const batch = formData.get('batch_number');
            if (!batch || batch.trim() === '') {
                alert('è«‹å¡«å¯«ã€Œæ‰¹è™Ÿã€');
                return;
            }

            try {
                const response = await fetch('/api/add_farm', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    alert('âœ… æ¤ç‰©å…¥åº«æˆåŠŸ');
                    form.reset();  // æ¸…ç©ºè¡¨å–®
                } else {
                    alert('âŒ éŒ¯èª¤ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                    console.error(result);
                }
            } catch (error) {
                alert('âŒ é€£ç·šå¤±æ•—ï¼š' + error.message);
                console.error(error);
            }
        }

        // ==================== å·¥ç¨‹æ•¸æ“šä¸Šå‚³ ====================
        async function saveProject() {
            // æ”¶é›†æ‰€æœ‰æ¬„ä½è³‡æ–™ (ä½¿ç”¨èˆ‡å¾Œç«¯å®Œå…¨å°æ‡‰çš„æ¬„ä½åç¨±)
            const payload = {
                project_name: document.getElementById('p_name').value.trim() || "æœªå‘½åæ¡ˆå ´",
                grid_type: document.getElementById('p_grid_type').value,
                grid_weight: parseFloat(document.getElementById('p_grid_weight').value) || 0,
                diesel_liters: parseFloat(document.getElementById('p_diesel').value) || 0,
                gasoline_liters: parseFloat(document.getElementById('p_gasoline').value) || 0,
                est_days: parseFloat(document.getElementById('p_days').value) || 0,
                pot_count: parseInt(document.getElementById('p_pots').value) || 0,
                plant_total_count: parseInt(document.getElementById('p_plants').value) || 0,
                drip_layers: parseInt(document.getElementById('p_layers').value) || 0,
                drip_len: parseFloat(document.getElementById('p_drip_len').value) || 0,
                water_est: parseFloat(document.getElementById('p_water').value) || 0,
                acc_weight: parseFloat(document.getElementById('p_acc').value) || 0
            };

            // æª¢æŸ¥å¿…è¦æ¬„ä½
            if (!payload.project_name || payload.project_name === "æœªå‘½åæ¡ˆå ´") {
                if (!confirm('æ¡ˆå ´åç¨±æœªå¡«ï¼Œå°‡å„²å­˜ç‚ºã€Œæœªå‘½åæ¡ˆå ´ã€ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ')) {
                    return;
                }
            }

            try {
                const response = await fetch('/api/add_project', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    alert('âœ… æ¡ˆå ´å»ºç«‹æˆåŠŸ');
                    // æ¸…ç©ºè¡¨å–® (å¯é¸)
                    document.getElementById('p_name').value = '';
                    document.getElementById('p_grid_weight').value = '';
                    document.getElementById('p_diesel').value = '';
                    document.getElementById('p_gasoline').value = '';
                    document.getElementById('p_days').value = '';
                    document.getElementById('p_pots').value = '';
                    document.getElementById('p_plants').value = '';
                    document.getElementById('p_layers').value = '';
                    document.getElementById('p_drip_len').value = '';
                    document.getElementById('p_water').value = '';
                    document.getElementById('p_acc').value = '';
                } else {
                    alert('âŒ éŒ¯èª¤ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                    console.error(result);
                }
            } catch (error) {
                alert('âŒ é€£ç·šå¤±æ•—ï¼š' + error.message);
                console.error(error);
            }
        }

        // æ¸¬è©¦é€£ç·š
        window.onload = async function() {
            try {
                const res = await fetch('/api/projects');
                if (res.ok) {
                    console.log('âœ… å¾Œç«¯é€£ç·šæ­£å¸¸');
                }
            } catch (e) {
                console.warn('âš ï¸ å¾Œç«¯é€£ç·šæ¸¬è©¦å¤±æ•—', e);
            }
        };
    </script>
</body>
</html>
