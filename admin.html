<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è•¨ç© | æ•¸æ“šç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100 p-4 md:p-10 font-sans">
    <div class="max-w-xl mx-auto space-y-8">
        <h1 class="text-3xl font-black text-slate-800 tracking-tighter">è•¨ç© ADMIN</h1>

        <div class="bg-white p-6 rounded-3xl shadow-xl border border-white">
            <h2 class="text-xl font-bold text-green-700 mb-6 flex items-center">
                <span class="mr-2">ğŸŒ¿</span> è¾²å ´æ•¸æ“šç™»éŒ„
            </h2>
            <div class="space-y-4">
                <input type="text" id="batch_number" placeholder="æ‰¹è™Ÿ (ä¾‹å¦‚: B2026-001)" class="w-full border p-4 rounded-2xl bg-gray-50 outline-none focus:ring-2 focus:ring-green-500 transition">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="plant_name" placeholder="æ¤ç‰©å“ç¨®" class="border p-4 rounded-2xl bg-gray-50 outline-none">
                    <input type="number" id="farm_qty" placeholder="å…¥åº«æ•¸é‡ (æ ª)" class="border p-4 rounded-2xl bg-gray-50 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 ml-2">é€²è²¨æ—¥æœŸ</label>
                        <input type="date" id="in_date" class="w-full border p-3 rounded-xl bg-gray-50">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 ml-2">é è¨ˆå‡ºè²¨</label>
                        <input type="date" id="out_date" class="w-full border p-3 rounded-xl bg-gray-50">
                    </div>
                </div>
                
                <div class="bg-slate-50 border-2 border-dashed border-gray-200 p-6 rounded-2xl text-center">
                    <input type="file" id="photo_file" accept="image/*" class="hidden">
                    <button type="button" onclick="document.getElementById('photo_file').click()" class="bg-white px-6 py-2 rounded-full shadow-sm border text-sm font-bold hover:bg-gray-50 transition">ğŸ“¸ æ‹æ”æˆ–é¸å–ç…§ç‰‡</button>
                    <p id="upload-status" class="text-[10px] mt-3 text-gray-400 italic">å°šæœªé¸å–æª”æ¡ˆ</p>
                </div>

                <button type="button" id="btn-farm" onclick="submitFarm()" class="w-full bg-green-600 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-green-700 active:scale-95 transition">å„²å­˜è¾²å ´æ•¸æ“š</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-xl border border-white">
            <h2 class="text-xl font-bold text-blue-700 mb-6 flex items-center">
                <span class="mr-2">ğŸ—ï¸</span> æ–°å¢æ¡ˆå ´è³‡æ–™
            </h2>
            <div class="space-y-4">
                <input type="text" id="p_name" placeholder="æ¡ˆå ´åç¨± (ä¾‹å¦‚: å°åŒ—å¤§å·¨è›‹)" class="w-full border p-4 rounded-2xl bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500 transition">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="p_area" placeholder="å»ºç½®å¹³æ–¹ç±³" class="border p-4 rounded-2xl bg-gray-50 outline-none">
                    <input type="number" id="p_plants" placeholder="æ¤æ ½éœ€æ±‚é‡" class="border p-4 rounded-2xl bg-gray-50 outline-none">
                </div>
                <label class="flex items-center space-x-3 p-4 bg-gray-50 rounded-2xl cursor-pointer">
                    <input type="checkbox" id="p_recycled" class="w-5 h-5 rounded border-gray-300 text-blue-600">
                    <span class="text-sm font-bold text-gray-600">æœ¬æ¡ˆå ´ä½¿ç”¨å¾ªç’°è³‡æ</span>
                </label>
                <button type="button" id="btn-project" onclick="submitProject()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-blue-700 active:scale-95 transition">å»ºç«‹æ¡ˆå ´</button>
            </div>
        </div>
    </div>

    <script>
        // è«‹æ›´æ›ç‚ºä½ çš„æ­£ç¢ºæ†‘è­‰
        const supabaseUrl = 'https://fvvbmedluaipqiqjiujj.supabase.co';
        const supabaseKey = 'sb_publishable_Y84MXL8nTojn_QJ_ba1e3w_GV7S7QRt';
        const supabase = supabasejs.createClient(supabaseUrl, supabaseKey);

        async function submitFarm() {
            const btn = document.getElementById('btn-farm');
            const file = document.getElementById('photo_file').files[0];
            let photoUrl = "";

            try {
                btn.innerText = "è™•ç†ä¸­...";
                btn.disabled = true;

                if (file) {
                    const fileName = `${Date.now()}_${file.name}`;
                    const { data, error } = await supabase.storage.from('evidences').upload(fileName, file);
                    if (error) throw error;
                    const { data: pUrl } = supabase.storage.from('evidences').getPublicUrl(fileName);
                    photoUrl = pUrl.publicUrl;
                }

                const payload = {
                    batch_number: document.getElementById('batch_number').value,
                    plant_name: document.getElementById('plant_name').value,
                    quantity: parseInt(document.getElementById('farm_qty').value) || 0,
                    in_stock_date: document.getElementById('in_date').value || null,
                    out_stock_date: document.getElementById('out_date').value || null,
                    photo_url: photoUrl
                };

                const res = await fetch('/api/add_farm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) throw new Error('API å‚³é€å¤±æ•—');
                alert('è¾²å ´æ•¸æ“šå·²æˆåŠŸéŒ„å…¥ï¼');
                location.reload();
            } catch (err) {
                alert('éŒ¯èª¤: ' + err.message);
            } finally {
                btn.innerText = "å„²å­˜è¾²å ´æ•¸æ“š";
                btn.disabled = false;
            }
        }

        async function submitProject() {
            const btn = document.getElementById('btn-project');
            try {
                btn.innerText = "å»ºç«‹ä¸­...";
                btn.disabled = true;

                const payload = {
                    project_name: document.getElementById('p_name').value,
                    area_sqm: parseFloat(document.getElementById('p_area').value) || 0,
                    plant_total_count: parseInt(document.getElementById('p_plants').value) || 0,
                    is_recycled: document.getElementById('p_recycled').checked
                };

                const res = await fetch('/api/add_project', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error('API å‚³é€å¤±æ•—');
                alert('å»ºæ¡ˆå»ºç«‹æˆåŠŸï¼');
                location.reload();
            } catch (err) {
                alert('éŒ¯èª¤: ' + err.message);
            } finally {
                btn.innerText = "å»ºç«‹æ¡ˆå ´";
                btn.disabled = false;
            }
        }

        document.getElementById('photo_file').onchange = function() {
            document.getElementById('upload-status').innerText = "å·²é¸å–: " + this.files[0].name;
        };
    </script>
</body>
</html>
