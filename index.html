<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>è•¨ç©ç¢³è¶³è·¡ - çœ‹è¦‹æ¯ä¸€å¤©çš„ç¶ è‰²è²¢ç»</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... åŸæœ‰çš„æ¨£å¼ ... */
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2e7d32;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .load-more-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #2e7d32;
            color: #2e7d32;
            padding: 0.75rem 2rem;
            border-radius: 2rem;
            font-weight: 600;
            transition: all 0.3s;
            margin: 1rem auto;
            display: inline-block;
        }
        
        .load-more-btn:hover {
            background: #2e7d32;
            color: white;
        }
        
        .load-more-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-lg mx-auto">
        <!-- æ¨™é ­ï¼ˆä¿æŒä¸è®Šï¼‰ -->
        <div class="header-center-block">
            <!-- ... æ¨™é ­å…§å®¹ ... -->
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ - ä½¿ç”¨è¼•é‡ç´š API -->
        <div class="grid grid-cols-3 gap-3 mb-6">
            <!-- æ­£åœ¨ç…§é¡§ -->
            <div class="stat-card">
                <div class="stat-value stat-green" id="total-plants">0</div>
                <div class="text-[11px] text-gray-500">æ­£åœ¨ç…§é¡§</div>
            </div>
            
            <!-- ç´¯ç©å¸æ”¶ -->
            <div class="stat-card">
                <div class="stat-value stat-blue" id="total-carbon">0 kg</div>
                <div class="text-[11px] text-gray-500">ç´¯ç©å¸æ”¶</div>
            </div>
            
            <!-- é€²è¡Œä¸­ -->
            <div class="stat-card">
                <div class="stat-value stat-purple" id="active-batches">0</div>
                <div class="text-[11px] text-gray-500">é€²è¡Œä¸­</div>
            </div>
        </div>

        <!-- æ‰¹æ¬¡åˆ—è¡¨ -->
        <div id="batches-container" class="space-y-4"></div>
        
        <!-- è¼‰å…¥æ›´å¤šæŒ‰éˆ• -->
        <div id="load-more-container" class="text-center hidden">
            <button id="load-more-btn" class="load-more-btn" onclick="loadNextPage()">
                è¼‰å…¥æ›´å¤š
            </button>
        </div>
        
        <!-- è¼‰å…¥ä¸­å‹•ç•« -->
        <div id="loading-spinner" class="loading-spinner hidden"></div>
        
        <!-- é å°¾èªªæ˜ -->
        <div class="mt-8 text-[10px] text-green-700/40 text-center border-t border-green-200/50 pt-4">
            <p>ğŸŒ± æ¯ä¸€å¤©çš„é¤Šè­·ï¼Œéƒ½åœ¨å¢åŠ å°åœ°çƒçš„è²¢ç»</p>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentPage = 1;
        let totalPages = 1;
        let isLoading = false;
        let allFarms = [];

        // è¼‰å…¥çµ±è¨ˆæ‘˜è¦
        async function loadSummary() {
            try {
                const res = await fetch('/api/summary');
                const data = await res.json();
                
                document.getElementById('total-plants').textContent = data.total_plants;
                document.getElementById('total-carbon').textContent = data.total_carbon_kg + ' kg';
                document.getElementById('active-batches').textContent = data.active_batches;
            } catch (e) {
                console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', e);
            }
        }

        // è¼‰å…¥ç¬¬ä¸€é è³‡æ–™
        async function loadFirstPage() {
            currentPage = 1;
            await loadFarms();
        }

        // è¼‰å…¥ä¸‹ä¸€é 
        async function loadNextPage() {
            if (currentPage < totalPages && !isLoading) {
                currentPage++;
                await loadFarms(true);
            }
        }

        // è¼‰å…¥æ‰¹æ¬¡è³‡æ–™
        async function loadFarms(isAppend = false) {
            if (isLoading) return;
            
            isLoading = true;
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('load-more-btn').disabled = true;
            
            try {
                const res = await fetch(`/api/farms?page=${currentPage}&limit=5`);
                const data = await res.json();
                
                totalPages = data.pagination.total_pages;
                
                if (!isAppend) {
                    allFarms = data.farms;
                    document.getElementById('batches-container').innerHTML = '';
                } else {
                    allFarms = [...allFarms, ...data.farms];
                }
                
                renderFarms(allFarms);
                
                // é¡¯ç¤º/éš±è—è¼‰å…¥æ›´å¤šæŒ‰éˆ•
                const loadMoreContainer = document.getElementById('load-more-container');
                if (currentPage < totalPages) {
                    loadMoreContainer.classList.remove('hidden');
                } else {
                    loadMoreContainer.classList.add('hidden');
                }
                
            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—:', e);
            } finally {
                isLoading = false;
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('load-more-btn').disabled = false;
            }
        }

        // æ¸²æŸ“æ‰¹æ¬¡åˆ—è¡¨ï¼ˆä½¿ç”¨è™›æ“¬æ²å‹•çš„æ¦‚å¿µï¼Œåªæ¸²æŸ“å¯è¦‹å€åŸŸï¼‰
        function renderFarms(farms) {
            const container = document.getElementById('batches-container');
            
            farms.forEach(farm => {
                const farmElement = createFarmCard(farm);
                container.appendChild(farmElement);
            });
        }

        // å»ºç«‹å–®ä¸€å¡ç‰‡ï¼ˆä½¿ç”¨ DocumentFragment å„ªåŒ–æ•ˆèƒ½ï¼‰
        function createFarmCard(farm) {
            const card = document.createElement('div');
            card.className = 'card';
            
            const days = farm.carbon_absorption?.days || calculateDays(farm.in_date);
            const progressPercent = Math.min(100, Math.round((days / 365) * 100));
            
            card.innerHTML = `
                <div class="flex gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 flex-wrap mb-2">
                            <span class="font-black text-lg text-green-700">${farm.batch_number}</span>
                            <span class="badge bg-green-100 text-green-800">${farm.plant_name || 'æœªå‘½å'}</span>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div>
                                <div class="text-[10px] text-gray-400">åº«å­˜</div>
                                <div class="font-bold text-green-600">${farm.quantity}</div>
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-400">å·²å‡ºè²¨</div>
                                <div class="font-bold text-purple-600">${farm.total_shipped || 0}</div>
                            </div>
                            <div>
                                <div class="text-[10px] text-gray-400">é€²è²¨æ—¥</div>
                                <div class="text-xs">${formatDate(farm.in_date)}</div>
                            </div>
                        </div>
                        
                        <!-- æ™‚é–“è»¸é€²åº¦æ¢ -->
                        <div class="mt-2 mb-3">
                            <div class="flex justify-between text-[10px] text-gray-500 mb-1">
                                <span>é¤Šè­· ${days} å¤©</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                <div class="progress-bar h-2 rounded-full" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>
                        
                        <!-- ç¢³å¸æ”¶å¡ç‰‡ -->
                        ${farm.carbon_absorption ? `
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-medium text-green-700">ç¢³å¸æ”¶</span>
                                    <span class="text-xs text-gray-500">Â±20%</span>
                                </div>
                                <div class="text-lg font-bold text-green-700">
                                    ${farm.carbon_absorption.value} kg
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- å³å´ç…§ç‰‡ -->
                    <div class="w-24 flex-shrink-0">
                        <div class="photo-container">
                            <img src="${farm.photo_url || 'https://via.placeholder.com/200?text=ğŸ“¸'}" 
                                 loading="lazy"
                                 onerror="this.src='https://via.placeholder.com/200?text=âŒ'"
                                 alt="æ¤ç‰©ç…§ç‰‡">
                        </div>
                    </div>
                </div>
                
                <!-- é¡¯ç¤ºæœ‰å¹¾ç­†ç”Ÿé•·ç´€éŒ„/å‡ºè²¨ç´€éŒ„ -->
                <div class="mt-2 text-xs text-gray-400 flex gap-3">
                    <span>ğŸ“¸ ${farm.growth_count || 0} ç­†ç´€éŒ„</span>
                    <span>ğŸ“¦ ${farm.shipments_count || 0} ç­†å‡ºè²¨</span>
                </div>
            `;
            
            return card;
        }

        // è¼”åŠ©å‡½æ•¸
        function formatDate(dateStr) {
            if (!dateStr) return 'ç„¡æ—¥æœŸ';
            try {
                const d = new Date(dateStr);
                return `${d.getFullYear()}/${(d.getMonth()+1)}/${d.getDate()}`;
            } catch {
                return dateStr;
            }
        }

        function calculateDays(inDate) {
            if (!inDate) return 0;
            try {
                const today = new Date();
                const inDateObj = new Date(inDate);
                return Math.floor((today - inDateObj) / (1000 * 60 * 60 * 24));
            } catch {
                return 0;
            }
        }

        // åˆå§‹åŒ–
        window.onload = async function() {
            await loadSummary();      // å…ˆè¼‰å…¥çµ±è¨ˆ
            await loadFirstPage();    // å†è¼‰å…¥ç¬¬ä¸€é è³‡æ–™
        };
    </script>
</body>
</html>
